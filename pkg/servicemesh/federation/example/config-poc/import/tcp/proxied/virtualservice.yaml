kind: VirtualService
apiVersion: networking.istio.io/v1alpha3
metadata:
  # imports-<service-name>-<mesh>
  name: imports-mongodb-aliased-mesh1
  namespace: mesh2-system
spec:
  hosts:
    # matches exported service name (fqdn)
    - mongodb-aliased.mesh1-exports.svc.cluster.local
    #- mongodb.mesh1-bookinfo.svc.cluster.local
  gateways:
    - mesh
    # gateway managing exported service, <service-name>-<target-mesh>
    - mesh2-system/imports-mongodb-aliased-mesh1
  tcp:
    - match:
        - gateways:
            - mesh
          port: 27017
      route:
        - destination:
            # egress gateway service
            host: federation-egress.mesh2-system.svc.cluster.local
            port:
              # gateway federation port
              number: 15443
            # <service>-<target-mesh>
            subset: mongodb-aliased-mesh1
    - match:
        - gateways:
            - mesh2-system/imports-mongodb-aliased-mesh1
          # gateway federation port
          port: 15443
      route:
        - destination:
            # remote service name (fqdn)
            host: mongodb-aliased.mesh1-exports.svc.cluster.local
            #host: mongodb.mesh1-bookinfo.svc.cluster.local
            port:
              number: 27017
          # XXX: what about multiple service ports?
  exportTo:
    - '*'
